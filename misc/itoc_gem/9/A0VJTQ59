µo«H¤H: itoc.bbs@xeon.tfcis.org (¬Ý¤FÃD¥Ø´Nª¾¹D¸Ó©ñ±ó) ¬ÝªO: plan
¼Ð  ÃD: [¥\¯à] ¨Ï¥ÎªÌ¦Û¤v¶}ªO
µo«H¯¸: °Ê¤O®Ö¤ß (Fri, 15 Aug 2003 01:24:54 +0800 (CST))  Updated: 2005/05/19

  ¦pªG¯¸¯uªº¬O¤p¨ì¤¹³\ÀH«Kª±ªº¸Ü...:p

  ¨º»ò´N¥i¥HÅý¨Ï¥ÎªÌ¦Û¤v¶}ªO¤F

  ³o¸Ì­­¨î¤F¶}ªOªº±ø¥ó¡A§A¥i¥HÀH«K§ï©Î¬O®³±¼
  1) ¥Î @xxxx.edu.tw »{ÃÒªº¨Ï¥ÎªÌ
  2) ¤W¯¸¦¸¼Æ¶W¹L 100 ¦¸
  3) µoªí¤å³¹¶W¹L 100 ½g

: admutil.c ³Ì«á¥[¤J³o´X­Ó¨ç¦¡

static int              /* 1:¬O¥»®Õªº email */
is_school_email()
{
  char *host;
  char foo[80];

  if (HAS_PERM(PERM_VALID))  /* Á×§K¥Î§Oªº«H½c»{ÃÒ¦A§ï¦¨¾Ç®Õ«H½c¦ý¨S»{ÃÒ */
  {
    str_lower(foo, cuser.email);

    host = (char *) strchr(foo, '@');
    *host++ = '\0';

    if (acl_has("run/personal_board", foo, host) > 0) /* ¦¹«H½c¤w¸g¶}¹LªO */
      return 0;

    if (!strcmp(host, "xxxx.edu.tw"))        [1;44m// ¦U®Õªº email ¦Û©w [m
      return 1;
  }

  return 0;
}


static int
hdr_cmp(a, b)
  HDR *a;
  HDR *b;
{
  /* ¥ý¤ñ¹ï¤ÀÃþ¡A¦A¤ñ¹ïªO¦W */
  int k = strncmp(a->title + BNLEN + 1, b->title + BNLEN + 1, BCLEN);
  return k ? k : str_cmp(a->xname, b->xname);
}


int
a_personal_board()
{
  BRD newboard;
  int bno;
  char fpath[64], brdname[BNLEN + 1];
  HDR hdr;
  ACCT acct;
  FILE *fp;
  char *fname = "gem/@/@Personal";      [1;44m// ¤ÀÃþ¦Û©w [m

#if 1   [1;44m// ³o¤@¬q¬O±ø¥óªºÀË¬d¡A¥i¥HÀH«K§ï©Î¬O®³±¼ [m
  if (!is_school_email())
  {
    vmsg("³o¥\\¯à¶È­­¥»®Õ¦P¾Ç¨Ï¥Î");
    return XEASY;
  }

  if (cuser.numlogins < 100)
  {
    vmsg("±z¤W¯¸¦¸¼Æ¨º»ò¤Ö¡A¤£¯à¾Ö¦³­Ó¤HªO");
    return XEASY;
  }

  if (cuser.numposts < 100)
  {
    vmsg("±zµoªí¤å³¹¨º»ò¤Ö¡A¤£¯à¾Ö¦³­Ó¤HªO");
    return XEASY;
  }
#endif

  [1;44m// ³o¸Ì¬O·QÅý­Ó¤HªO¦³¤°»òªO¦W¡A¤U­±¤G¦æ¥u¯à¿ï¤@¦æ [m
  sprintf(brdname, "P_%.10s", cuser.userid);  /* ªO¦W¬° P_userid */
  strcpy(brdname, cuser.userid);              /* ªO¦W§Y¬° userid */

  if (brd_bno(brdname) >= 0)
  {
    vmsg("±z¤w¸g¦³ªO¤F¡I");
    return XEASY;
  }

  if (vans("­n¥Ó½Ð­Ó¤HªO(Y/N)¡H[N] ") != 'y')
    return XEASY;

  memset(&newboard, 0, sizeof(newboard));

  newboard.battr = BRD_NOTRAN;
  newboard.postlevel = PERM_POST;
  strcpy(newboard.brdname, brdname);
  strcpy(newboard.class, "­Ó¤H");
  strcpy(newboard.title, "ªO¦W¦b¬ÝªO¸Ì«ö B ¦Û¤v§ï");
  strcpy(newboard.BM, cuser.userid);

  /* ¥[ªO¥DÅv­­ */
  cuser.userlevel |= PERM_BM;
  if (acct_load(&acct, cuser.userid) >= 0)
    acct_setperm(&acct, PERM_BM, 0);

  time(&newboard.bstamp);
  if ((bno = brd_bno("")) >= 0)
  {
    rec_put(FN_BRD, &newboard, sizeof(newboard), bno, NULL);
  }
  /* Thor.981102: ¨¾¤î¶W¹Lshm¬ÝªO­Ó¼Æ */
  else if (bshm->number >= MAXBOARD)
  {
    vmsg("¶W¹L¨t²Î©Ò¯à®e¯Ç¬ÝªO­Ó¼Æ¡A½Ð½Õ¾ã¨t²Î°Ñ¼Æ");
    return XEASY;
  }
  else if (rec_add(FN_BRD, &newboard, sizeof(newboard)) < 0)
  {
    vmsg("µLªk«Ø¥ß·sªO");
    return XEASY;
  }

  sprintf(fpath, "gem/brd/%s", brdname);
  mak_dirs(fpath);
  mak_dirs(fpath + 4);

  brd2gem(&newboard, &hdr);
  rec_add(fname, &hdr, sizeof(HDR));
  rec_sync(fname, sizeof(HDR), hdr_cmp, NULL);

  bshm_reload();                /* force reload of bcache */

  system("bin/account -nokeeplog");
  brh_save();
  board_main();                 /* reload brd_bits[] */

#if 1
  /* °O¿ý¤w¸g¶}­ÓªOªº E-mail */
  if (fp = fopen("run/personal_board", "a"))
  {
    fprintf(fp, "%s\n", cuser.email);
    fclose(fp);
  }
#endif

  vmsg("·sªO¦¨¥ß¡A½Ð¦b¬ÝªO¸Ì«ö B °µ¶i¶¥³]©w");
  return 0;
}

: menu.c ¾A·íªº¿ï³æ¥[¤J

  "bin/admutil.so:a_personal_board", PERM_VALID, - M_XMODE,
  "Board      ¡i ¶}­Ó¤HªO ¡j",

--
  ¤£¶È¶}ªO§K³s¸p¡A²{¦b³sµ¥«Ý³£§K¤F¡I

--
[1;36m=[37m[[36m¡É[37m:[33m¡[37mÝ¢¨[m¢©¡[1;33mÝ[37m:[36m¡É [31mOrigin[37m ]|[[m     [31m°[1mÊ¤[0;31mO®[1mÖ¤[0;31mß [1mprocessor.tfcis.org    [37m]|[¡[33mÝ£»¡[mÝ[1;36m¡É[37m:][36m=[m
[1;36m=[m[[1;36m¡Ç[37m:[33m¡[30mÝ¢ª[m¢¬¡[1;33mÝ[37m:[36m¡Ç [31mAuthor[m ]|[ [1m    itoc.Dorm11.NCTU.edu.tw         [m]|[¡[1;33mÝ[30m¡[37m´¡[30mÝ[36m¡Ç[37m:[m][1;36m=[m
