µo«H¤H: bluesway.bbs@bluesway.tfcis.org (¶³²H­·»´) ¬ÝªO: plan
¼Ð  ÃD: cygwin ¬ÛÃ¯¥\¯à
µo«H¯¸: çn¸ô¤p¿v (2005/07/20 Wed 21:13:20)                Updated: 2005/07/20

¦]¬°ºëµØ°Ï¸Ìªº BBS ±b¸¹»P¬ÛÃ¯¦P¨B ¤@ª½§Ë¤£°_¨Ó

¥[¤W·Q¦h¨Ç¥\¯à

´N¦Û¤v¼g¤F¤@¤äµ{¦¡

¨Ï¥ÎªÌ¦Û¤v¨M©w­n¤£­n¶}¬ÛÃ¯

ÁÙ¥i¥Hªá¿ú¶R¬ÛÃ¯ªºªÅ¶¡ (¤£µM¦³¿ú³£¨S¦a¤èªá)

­n¥ý§Q¥Î AppServ ¬[¯¸¡A¦A¬[³] Coppermine Photo Gallery

¥H¤Uµ{¦¡³]­p¦b cygwin ¤¤¹B§@

¨ä¥¦§@·~¨t²Î¥i¯à¦³¨Ç¦a¤è­n¦Û¤v­×¥¿¤@¤U

¥t¥~¡A§Úªº¥\¤O«Ü²L¡A¥i¯àµ{¦¡¹B§@®Ä²v¤£¬O«Ü¦n

Åwªï°ª¤â«ü¥¿­×§ï :)


: maple/menu.c ¾A·í¿ï¶µ¤¤¥[¤J

+ main_album, PERM_BASIC, M_GAME,
+ "Gallery    ¡ñ ³]©w¬ÛÃ¯ ¡ð",


: maple/Makefile

SRC =
        ../so/jcee.c ../so/dict.c ../so/lottery.c [1;33m../so/album.c[m \

OBJ =
        ../so/jcee.o ../so/dict.o ../so/lottery.o [1;33m../so/album.o[m \


: maple/bbsd.c:belong_list() ®³±¼ static

- static int         /* 1:¦blist¤¤ 0:¤£¦blist¤¤ */
+ int         /* 1:¦blist¤¤ 0:¤£¦blist¤¤ */
belong_list(filelist, key, desc)


: maple/maple.p

/* bbsd.c */
+ int belong_list(char *filelist, char *key, char *desc);

...

/* so */
+ int main_album();


: include/global.h

#define FN_ETC_LOVELETTER "etc/loveletter"  /* ±¡®Ñ²£¥Í¾¹¤å®w */
#define FN_ETC_CLASS    "etc/class"           /* ¬ÝªO¤ÀÃþÃC¦â */
+ #define FN_ETC_ALBUM        "etc/album"     /* ¬ÛÃ¯ */

...

/* ----------------------------------------------------- */
/* °T®§¦r¦ê¡G¿W¥ß¥X¨Ó¡A¥H§Q¤ä´©¦UºØ»y¨¥          */
/* ----------------------------------------------------- */

+ #define MYSQL_PATH  "/cygdrive/c/AppServ/mysql/bin/mysql"
+                                  /* MySQL °õ¦æÀÉªº¸ô®| */
+ #define ROOTPASS    "bedbtkbryowtdemrcouwxkatieixhxgns"
+                                  /* MySQL ºÞ²zªÌ±K½X */


: maple/acct.c:acct_setup() §ï±K½X®É¶¶«K§ï¬ÛÃ¯±K½X

acct_setup(u, adm)
  ACCT *u;
  int adm;
{
  ACCT x;
  int i, num;
  char *str, buf[80], pass[PSWDLEN + 1];
+ char cmd[256], quota[27]

...

      vget(i + 1, 0, "ÀË¬d·s±K½X¡G", buf, PSWDLEN + 1, NOECHO);
      if (!strcmp(buf, pass))
      {
        str_ncpy(x.passwd, genpasswd(buf), sizeof(x.passwd));

+       if (belong_list(FN_ETC_ALBUM, x.userid, quota))
+       {
+         sprintf(cmd, MYSQL_PATH" -p"ROOTPASS" -e \"use cpg132;"
+           "Update cpg132_users Set user_password=\'%s\' "
+           "Where user_name=\'%s\';\"", buf, x.userid);
+         system(cmd);
+       }

        break;
      }

: so/album.c ·s¼W¦¹µ{¦¡

/*-------------------------------------------------------*/
/* so/album.c           ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : ¬ÛÃ¯¥\¯à                                     */
/* create : 05/06/06                                     */
/* author : bluesway@tfcis.org                           */
/*-------------------------------------------------------*/

#include "bbs.h"

#if 0

    ¥»µ{¦¡°²³] AppServ ¬O«ö·Ó¹w³]¸ô®|¦w¸Ë (¤£¬Oªº¸Ü­n§ï MYSQL_PATH)
    cpg ¸ê®Æ®wªº¬ÛÃö³]©w¤]³£«ö·Ó¹w³]­È¨Ó¦w¸Ë

    ¦b cpg ¸ê®Æ®w¤¤¡A¨C­Ó¨Ï¥ÎªÌ¦U¦Û¦¨¤@­Ó group (¤~¯à§ï quota)
    ¨Ã¥H userno ·í§@ group id

    ¨Ï¥ÎªÌ¥i¥H¥ÎªºªÅ¶¡­­¨î°O¿ý¦b FN_ETC_ALBUM

#endif

#define P_ALBUM     50000   /* ¨C¥»¬ÛÃ¯ªº»ù®æ */
#define P_BQUOTA    10      /* ¨C¶R 1KB ¬ÛÃ¯ªÅ¶¡ªº»ù®æ */
#define P_SQUOTA    8       /* ¨C½æ 1KB ¬ÛÃ¯ªÅ¶¡ªº»ù®æ */
#define QUOTA       10240   /* ¹w³]ªº¬ÛÃ¯ªÅ¶¡ (KB) */

static int
album_create()
{
  char passwd[PSWDLEN + 1], regtime[50], cmd[200];
  struct tm *local;
  time_t now;
  FILE *fp;

  /* regtime ­É¨Ó¶ñ¤@¤U°Ñ¼Æ */
  if (!belong_list(FN_ETC_ALBUM, cuser.userid, regtime))
  {
    sprintf(cmd, "¶R¬ÛÃ¯»Ý­nªá %d »È¹ô³á¡I", P_ALBUM);
    vmsg(cmd);

    if (cuser.money < 50000 || vans("½T©w­n¶R¶Ü¡H[Y/n]") == 'n')
      return XO_FOOT;
  }
  else
  {
    vmsg("±z¤w¸g¦³¬ÛÃ¯¤F¡I");
    return XO_FOOT;
  }

  vget(b_lines, 0, "¡» ½Ð¿é¤J±K½X½T»{¡G", passwd, PSWDLEN + 1, NOECHO);

  if (chkpasswd(cuser.passwd, passwd))
  {
    vmsg("Sorry..±K½X¦³»~¡I");
    return XO_FOOT;
  }

  local = localtime(&now);
  time(&now);
  sprintf(regtime, "%.4d-%.2d-%.2d %.2d:%.2d:%.2d", local->tm_year + 1900,
        local->tm_mon + 1, local->tm_mday, local->tm_hour, local->tm_min,
        local->tm_sec);

  if (!HAS_PERM(PERM_SYSOP))  /* ¯¸ªø¤@©w¬O CPG ºÞ²z­û¸s²Õ¡A¤£¥²¥t«Ø¸s²Õ */
  {
    sprintf(cmd, MYSQL_PATH" -p"ROOTPASS" -e \"use cpg132;Insert "
      "cpg132_usergroups(group_id,group_name) Values(%d,\'%s\');\"",
      cuser.userno, cuser.userid);
    system(cmd);
  }

  sprintf(cmd, MYSQL_PATH" -p"ROOTPASS" -e \"use cpg132;Insert "
    "cpg132_users(user_group,user_name,user_password,user_regdate) "
    "Values(%d,\'%s\',\'%s\',\'%s\');\"",
    (HAS_PERM(PERM_SYSOP) ? 1 : cuser.userno), cuser.userid,
    passwd, regtime);
  system(cmd);

  fp = fopen(FN_ETC_ALBUM, "a");
  /* ¯¸ªø¤£»Ý­n­­¨î quota */
  fprintf(fp, "%s %d\n", cuser.userid, (HAS_PERM(PERM_SYSOP) ? 0 : QUOTA));
  fclose(fp);

  /* ¯¸ªø¶R¬ÛÃ¯¤£¥Î¿ú */
  cuser.money -= HAS_PERM(PERM_SYSOP) ? 0 : P_ALBUM;

  /* ­É regtime ©M cmd ¨Ó ¨q°T®§ */
  sprintf(regtime, "%.3f MB", QUOTA / 1024.0);
  sprintf(cmd, "¬ÛÃ¯«Ø¥ß§¹¦¨¡I¯¬¨Ï¥Î´r§Ö..±z¥Ø«e¦³¥i¥ÎªÅ¶¡ %s¡C",
        (HAS_PERM(PERM_SYSOP) ? "µL­­¤j" : regtime));
  vmsg(cmd);
}


static int
album_buyquota()
{
  int num, update;
  char buf[50], quota[27], cmd[200], fpath[64];
  FILE *fpr, *fpw;

  if (!belong_list(FN_ETC_ALBUM, cuser.userid, quota))
  {
    vmsg("±z©|¥¼ÁÊ¶R¬ÛÃ¯³á¡I");
    return XO_FOOT;
  }

  sprintf(cmd, "¬ÛÃ¯ªÅ¶¡ %d»È / KBytes¡A±z­n¶R¦h¤Ö KB ©O¡H", P_BQUOTA);

  if (!vget(b_lines, 0, cmd, buf, 11, DOECHO))
    return XO_FOOT;

  num = atoi(buf);

  if (cuser.money < num * P_BQUOTA)
  {
    vmsg("±zªº²{ª÷¤£¨¬¡I");
    return XO_FOOT;
  }

  update = atoi(quota) + num;

  if (update < 0)
  {
    vmsg("±z¨S¦³¨¬°÷ªÅ¶¡¥i¥HÄÀ¥X");
    return XO_FOOT;
  }

  sprintf(cmd, MYSQL_PATH" -p"ROOTPASS" -e \"use cpg132;"
    "Update cpg132_usergroups Set group_quota=%d "
    "Where group_name=\'%s\';\"", update, cuser.userid);
  system(cmd);

  fpr = fopen(FN_ETC_ALBUM, "r");
  sprintf(fpath, "%s.tmp", FN_ETC_ALBUM);
  fpw = fopen(fpath, "w");

  /* ­É¥Î cmd, buf ¨Ó§ó·s¸ê®Æ */
  while (fgets(cmd, sizeof(cmd), fpr))
  {
    if (strstr(cmd, cuser.userid))
    {
      sprintf(buf, "%s %d\n", cuser.userid, update);
      strcpy(cmd, buf);
    }
    fputs(cmd, fpw);
  }
  fclose(fpw);
  fclose(fpr);
  unlink(FN_ETC_ALBUM);
  rename(fpath, FN_ETC_ALBUM);

  cuser.money -= num < 0 ? num * P_SQUOTA : num * P_BQUOTA;

  if (num >= 0)
    sprintf(cmd, "ÁÊ¶R %d KB¡Aªá¶O %d »È¹ô¡I±z¥Ø«e¥i¨Ï¥ÎªºªÅ¶¡¬O %.3f MB¡C",
        num, num * P_BQUOTA, update / 1024.0);
  else
    sprintf(cmd, "ÄÀ¥X %d KB¡A´«¦^ %d »È¹ô¡I±z¥Ø«e¥i¨Ï¥ÎªºªÅ¶¡¬O %.3f MB¡C",
        num * -1, num * P_SQUOTA * -1, update / 1024.0);
  vmsg(cmd);
}


int
main_album()
{
  int ans;

  switch (ans = vans("¡· ¬ÛÃ¯ 1)«Ø¥ß¬ÛÃ¯ 2)ÁÊ¶R®e¶q¡H[Q] "))
  {
    case '1':
      album_create();
      break;

    case '2':
      if (!HAS_PERM(PERM_SYSOP)) /* ¯¸ªø¤£»Ý­n */
        album_buyquota();
      break;

    default:
      return XEASY;
  }
}

--


        [1m§A¤w¸g©úÁA¤F¶Ü¡H¨º´N¥h°µ§a¡I[m

--
 [1;36;44m¢¨[;37;44m¢©[1;30;40m±­±­©óÂ²µuªº [37;47mbluesway.tfcis.org[30;40m §ÚµLªk¨¥»y©t¿W±jÅ§¤W [37;44mçn¸ô¤p¿v[m
 [1;44m¢ª[34m¢«[30;40m¤Û¤Æ¬°Ëñ®F¤¤¤@©Ù [34;44mbluesway[30;40m ªº²H¼v§Ú§ä¤£¨ì¥X¤f¦^¨ì [34;47m218-171-208-186.dynamic.[m
