µo«H¤H: amaki.bbs@luna.twbbs.org (Åx¦Ï¥¤Âà°é°é) ¬ÝªO: plan
¼Ð  ÃD: [¥\¯à]¬ÝªO¤H®ð¡BÂsÄý®É¶¡¡BCP±Æ¦æ»P²Î­p~4
µo«H¯¸: ¤ë¤U©]·Q (Sat, 16 Aug 2003 10:10:37 +0800 (CST))  Updated: 2003/12/18

  util/¤U·s¼W³o°¦ brdcounter.c


/*-------------------------------------------------------*/
/* util/brdcounter.c         (MapleBBS Ver 3.10 )        */
/*-------------------------------------------------------*/
/* target : ·í¤é¬ÝªO¤G¤Q¥|¤p®É²Î­p¹Ï                     */
/* create : 03/07/22                                     */
/* author : amaki.bbs@luna.twbbs.org                     */
/*-------------------------------------------------------*/

#include  "bbs.h"

static BCACHE *bshm;

typedef struct
{
  int d_mantime[31];
  int w_mantime[7];
  int m_mantime[12];
  int hr_mantime[24];

  long int d_time[31];
  long int w_time[7];
  long int m_time[12];
  long int hr_time[24];

  int d_cp[31];
  int w_cp[7];
  int m_cp[12];
  int hr_cp[24];
} DATA;


typedef struct
{
  int year;
  int yday;
  int mon;
  int mday;
  int hour;
} DATE;

static int hr_data[24];


static void
hr_draw(brd, now, old, fn_name, bno, t_deg, key)
  BRD *brd;
  DATE *now, *old;
  char *fn_name, *t_deg;
  int bno, key;
{
  int max = 0, unit, deg, res, i = 0, j = 0;
  FILE *fp;
  HDR post;
  char fpath[64], folder[64], buf[80];
  char *block[11] =
  {
    "  ", "¡Ä", "¢b", "¢c", "¢d", "¢e", "¢f", "¢g", "¢h", "¢i", "¢i"
  };

  for (i = 0; i < old->hour + 1; i++)
  {
    if (hr_data[i] > max)
      max = hr_data[i];
  }

  brd_fpath(fpath, brd->brdname, fn_name);
  fp = fopen(fpath, "w");

  if (max > 18)
    unit = (max % 19) ? (max / 19) + 1 : max / 19;
  else
    unit = 1;

  if (key == 1)
    fprintf(fp, "\033[1m%-12s\033[mªO%d¤ë%d¤é¤H¦¸²Î­p¹Ï\n", brd->brdname, old->mon, old->mday);
  else if (key == 2)
    fprintf(fp, "\033[1m%-12s\033[mªO%d¤ë%d¤é¨Ï¥Î®É¶¡²Î­p¹Ï(³æ¦ì:\033[1;33m%s\033[m)\n", brd->brdname, old->mon, old->mday, t_deg);
  else if (key == 3)
    fprintf(fp, "\033[1m%-12s\033[mªO%d¤ë%d¤éCP²Î­p¹Ï(³æ¦ì¡G\033[1;33m%s\033[m)\n", brd->brdname, old->mon, old->mday, t_deg);

  for (j = 0; j < 20; j++)
  {
    deg = (unit != 1) ? (unit / 2) + unit * (19 - j) : unit + unit * (19 - j);
    fprintf(fp, "\033[1;36m%3d\033[37m¢t\033[m", deg);

    for (i = 0; i < old->hour + 1; i++)
    {
      if (hr_data[i] > unit * (19 - j))
      {
        if (((hr_data[i] - unit * (19 - j)) / unit) >= 1)
          fprintf(fp, "\033[1;34m%3s\033[m", block[10]);
        else
        {
          res = ((hr_data[i] - unit * (19 - j)) * 10)/ unit;
          fprintf(fp, "\033[1;34m%3s\033[m", block[res]);
        }
      }
      else if ((hr_data[i] > unit * (18 - j)) && (hr_data[i] <= unit * (19 - j)))
        fprintf(fp, "\033[1;33m%3d\033[m", hr_data[i]);
      else
        fprintf(fp, "   ");
    }

    fprintf(fp, "\n");
  }

  fprintf(fp, "  \033[1;36m0\033[37m¢|¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢t\n");
  fprintf(fp, "(Hr)\033[1;32m0  1  2  3  4  5  6  7  8  9  10  11 12 13 14 15 16 17 18 19 20 21 22 23 24\033[m\n");
  fclose(fp);

  /* amaki.030815: ½Æ»s¤@¥÷¨ìrec_boardªO¥h */
  if (now->hour == 0)
  {
    brd_fpath(folder, "rec_board", FN_DIR);
    hdr_stamp(folder, HDR_COPY, &post, fpath);
    strcpy(post.owner, "sysop");

    if (key == 1)
      sprintf(buf, "[%d ¤ë %d ¤é] %-12sªO¤H®ð²Î­p", old->mon, old->mday, (brd->battr & BRD_NOSTAT) ? "¡³¡³¡³¡³" : brd->brdname);
    else if (key == 2)
      sprintf(buf, "[%d ¤ë %d ¤é] %-12sªO¨Ï¥Î®É¶¡²Î­p", old->mon, old->mday, (brd->battr & BRD_NOSTAT) ? "¡³¡³¡³¡³" : brd->brdname);
    else if (key == 3)
      sprintf(buf, "[%d ¤ë %d ¤é] %-12sªOCP²Î­p", old->mon, old->mday, (brd->battr & BRD_NOSTAT) ? "¡³¡³¡³¡³" : brd->brdname);

    strcpy(post.title, buf);
    if (brd->battr & BRD_NOSTAT)
      post.xmode |= POST_RESTRICT;
    rec_add(folder, &post, sizeof(post));
  }
}


static void
data_draw(data, brd, now, old, bno)
  DATA *data;
  BRD *brd;
  DATE *now, *old;
  int bno;
{
  int i, max = 0;
  char deg[8];

  for (i = 0; i < old->hour + 1; i++)
  {
    hr_data[i] = data->hr_mantime[i];
  }
  hr_draw(brd, now, old, "hr_mantime", bno, NULL, 1);

  /* amaki.030816: ¼Æ­È¤Ó¤j³y¦¨±Æª©¿ù¶Ã¡A¯S§O³B²z */
  for (i = 0; i < old->hour + 1; i++)
  {
    if (data->hr_time[i] > max)
      max = data->hr_time[i];
  }

  if (max > 999)
  {
    for (i = 0; i < old->hour + 1; i++)
    {
      hr_data[i] = data->hr_time[i] / 60;
    }
    strcpy(deg, "¤À");
    hr_draw(brd, now, old, "hr_time", bno, deg, 2);
  }
  else
  {
    for (i = 0; i < old->hour + 1; i++)
    {
      hr_data[i] = data->hr_time[i];
    }
    strcpy(deg, "¬í");
    hr_draw(brd, now, old, "hr_time", bno, deg, 2);
  }

  max = 0;
  for (i = 0; i < old->hour + 1; i++)
  {
    if (data->hr_cp[i] > max)
      max = data->hr_cp[i];
  }

  if (max > 999)
  {
    for (i = 0; i < old->hour + 1; i++)
    {
      hr_data[i] = data->hr_cp[i] / 60;
    }
    strcpy(deg, "¤À");
    hr_draw(brd, now, old, "hr_cp", bno, deg, 3);
  }
  else
  {
    for (i = 0; i < old->hour + 1; i++)
    {
      hr_data[i] = data->hr_cp[i];
    }
    strcpy(deg, "¬í");
    hr_draw(brd, now, old, "hr_cp", bno, deg, 3);
  }
}


static void
data_feed(brd, now, old, bno)
  BRD *brd;
  DATE *now, *old;
  int bno;
{
  DATA data;
  int fd, i;
  char fpath[80];

  brd_fpath(fpath, brd->brdname, "bdata");
  fd = open(fpath, O_RDWR | O_CREAT, 0600);
  read(fd, &data, sizeof(DATA));

  data.hr_mantime[old->hour] = bshm->hr_mantime[bno];
  data.hr_time[old->hour] = bshm->hr_time[bno];
  data.hr_cp[old->hour] = (data.hr_mantime[old->hour] > 0) ?
    data.hr_time[old->hour] / data.hr_mantime[old->hour] : 0;

  data_draw(&data, brd, now, old, bno);

  bshm->hr_mantime[bno] = bshm->hr_time[bno] = 0;

  if (now->hour == 0)
  {
    for (i = 0; i < 24; i++)
    {
      data.hr_mantime[i] = 0;
      data.hr_time[i] = 0;
      data.hr_cp[i] = 0;
    }
  }

  lseek(fd, (off_t) (sizeof(DATA) * 0), SEEK_SET);
  write(fd, &data, sizeof(DATA));
  close(fd);
}


int
main()
{
  int i;
  BRD *brd;
  DATE now, old;
  time_t time_now;
  struct tm *t;

  chdir(BBSHOME);
  bshm = shm_new(BRDSHM_KEY, sizeof(BCACHE));

  time(&time_now);
  t = localtime(&time_now);
  now.year = t->tm_year;
  now.yday = t->tm_yday;
  now.mon = t->tm_mon + 1;
  now.mday = t->tm_mday;
  now.hour = t->tm_hour;

  /* amaki.030816: §â®É¶¡©¹¦^¼·¨ì¤W¤@­Ó¤p®É¡A¤è«K¨Ï¥Î */
  time(&time_now);
  time_now -= 400;
  t = localtime(&time_now);
  old.year = t->tm_year;
  old.yday = t->tm_yday;
  old.mon = t->tm_mon + 1;
  old.mday = t->tm_mday;
  old.hour = t->tm_hour;

  for (i = 0; i < bshm->number; i++)
  {
    brd = bshm->bcache + i;
    /* amaki.030730: ¶}±Ò¬ÝªO¥Ø¿ý¤Uªºbdata */
    data_feed(brd, &now, &old, i);
  }
  return 0;
}

--
  [1;33mOrigin: luna.twbbs.org[m
