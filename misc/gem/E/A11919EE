µo«H¤H: itoc.bbs@processor.tfcis.org (®Ö¤ß°Ê¤O) ¬ÝªO: plan
¼Ð  ÃD: Re: ½Ð°Ý­×§ï¤å³¹/«H¥óÀÉÀY
µo«H¯¸: °Ê¤O®Ö¤ß (2004/02/26 Thu 23:38:50)                Updated: 2005/05/22

¡° ¤Þ­z¡mAwing (¤s©Y¦Ï)¡n¤§»Ê¨¥¡G
> ¬°¤F¾AÀ³ÂÂ¯¸¨Ï¥ÎªÌ²ßºD,
> §Ú§âÀÉÀY¦h¥[¤W¤F¤@ºb,
> ¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w

  ­º¥ý¥ý°µºëµØ°Ï³o½g
  [­×¥¿] more.c ¥Ñ buffered file read §ï¦¨ full file read

: more.c:more()

int
more(fpath, footer)
  char *fpath;
  char *footer;
{
+ #define MSG_SEPERATE    "\033[36m"MSG_SEPERATOR"\033[m\n"
+ uschar *fnew;

  ...
  ...

  if (!(fimage = f_img(fpath, &fsize)))
    return -1;

  foff = fimage;
  fend = foff + fsize;

+ i = 0;
+ while (more_line(buf))
+ {
+   if (*buf)       /* ¦³¤º®e´N¤@©w¬OÀÉÀY */
+   {
+     if (!strstr(buf, ": "))
+       break;
+   }
+   else            /* ²Ä¤@¦¸ "\n\n" ¬OÀÉÀYªºµ²§À */
+   {
+     if (i != LINE_HEADER)
+       break;
+
+     lino = strlen(MSG_SEPERATE);
+
+     if (!(fnew = malloc(fsize + lino)))
+     {
+       free(fimage);
+       return -1;
+     }
+
+     foff--;        /* ¦^¨ìÀÉÀY³Ì«á */
+
+     shift = foff - fimage;
+     memcpy(fnew, fimage, shift);
+     memcpy(fnew + shift, MSG_SEPERATE, lino);
+     memcpy(fnew + shift + lino, foff, fsize - shift);
+
+     free(fimage);
+     fsize += lino;
+     fimage = foff = fnew;
+     fend = foff + fsize;
+     break;
+   }
+   if (++i > LINE_HEADER)  /* ²Ä¤@¦¸ "\n\n" ªº¦ì¸m¤£·|¶W¹L LINE_HEADER */
+     break;
+ }

  /* Åª¥XÀÉ®×²Ä¤@¦æ¡A¨Ó§PÂ_¯¸¤º«HÁÙ¬O¯¸¥~«H */
  if (fsize <= 0 || !more_line(buf))
  {
    free(fimage);
    return -1;
  }

--
 [1;43m¢~[46m¢q[m Or[1mig[30min[m: [41m Maple-itoc£»°Ê¤O®Ö¤ß [32;47m processor.tfcis.org [m
 [1;44m¢q[41m¢£[m A[1mut[30mho[mr: [1;33mitoc [30m±q [35mitoc.dorm11.nctu.edu.tw [30mµoªí[m
