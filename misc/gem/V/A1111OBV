§@ªÌ: itoc (¯¸¤W¤H¼Æ¡G802) ¯¸¤º: plan
¼ÐÃD: [¥\¯à] ²M°£¹LÂÂªº¤W¯¸¨Ó·½°O¿ý
®É¶¡: 2005/02/15 Tue 01:25:24                           Updated: 2005/02/15

  usr/u/userid/log ³o­Ó¡y¤W¯¸¨Ó·½°O¿ý¡z·|¦]¦~¥N¤[»·¦ÓÅÜ±o«ÜªÎ¤j
  ³o­Óµ{¦¡¥i¥H§R°£¹LÂÂªº°O¿ý

: src/util/Makefile

EXE =   ..... [1;33mdelog[m

: src/util/delog.c ·s¼W³oµ{¦¡

/*-------------------------------------------------------*/
/* util/delog.c         ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : ²M°£¹LÂÂªº¤W¯¸¨Ó·½°O¿ý                       */
/* create : 05/02/14                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/
/* syntax : delog [userid]                               */
/*-------------------------------------------------------*/


#include "bbs.h"


#define KEEP_DAYS       180     /* ¥u«O¯d³Ìªñ 180 ¤Ñªº¤W¯¸¨Ó·½°O¿ý */


static int now;


static int
decode_Btime(str)
  char *str;
{
  /* ¨Ì Btime() ®æ¦¡¤£¦P¦ÓÅÜ */

  /* ¬°Â²³æ°_¨£¡A¤£¦Ò¼{¶|¦~¤Î¤j¤p¤ë¡A©Ò¥H¹ê»Ú«O¯dªº¤é´Á·|©M KEEP_DAYS ²¤¦³¤£¦P
 */
  return atoi(str) * 365 + atoi(str + 5) * 31 + atoi(str + 8);
}


static void
delog(fpath)
  char *fpath;
{
  int keep;
  char fnew[64], buf[256];
  FILE *fpr, *fpw;

  if (fpr = fopen(fpath, "r"))
  {
    sprintf(fnew, "%s.new", fpath);
    if (fpw = fopen(fnew, "w"))
    {
      keep = 0;
      while (fgets(buf, sizeof(buf), fpr))
      {
        if (!keep)
        {
          if (decode_Btime(buf) >= now)
            keep = 1;
        }

        if (keep)
          fputs(buf, fpw);
      }

      fclose(fpw);
    }
    fclose(fpr);

    unlink(fpath);
    rename(fnew, fpath);
  }
}


int
main(argc, argv)
  int argc;
  char *argv[];
{
  char c, *str, fpath[64];
  struct dirent *de;
  DIR *dirp;

  if (argc > 2)
  {
    printf("Usage: %s [userid]\n", argv[0]);
    return -1;
  }

  chdir(BBSHOME);

  now = decode_Btime(Now()) - KEEP_DAYS;

  if (argc == 2)
  {
    usr_fpath(fpath, argv[1], FN_LOG);
    delog(fpath);
    return 0;
  }

  for (c = 'a'; c <= 'z'; c++)
  {
    sprintf(fpath, "usr/%c", c);
    chdir(fpath);

    if (!(dirp = opendir(".")))
      continue;

    while (de = readdir(dirp))
    {
      str = de->d_name;
      if (*str <= ' ' || *str == '.')
        continue;

      sprintf(fpath, "%s/" FN_LOG, str);
      delog(fpath);
    }

    closedir(dirp);
  }

  return 0;
}

--
  ÆZ¦Y I/O ªº¡A¤[¤[¶]¤@¦¸´N¥i¥H¤F

--
[1;37m¡¼ ¥»¤å³¹¥Ñ [33mitoc[37m ±q [32mitoc.Dorm11.NCTU.edu.tw[37m µoªí[m
