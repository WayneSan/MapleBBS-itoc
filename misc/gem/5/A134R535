µo«H¤H: itoc.bbs@cpu.tfcis.org (®Ö¤ß°Ê¤O) ¬ÝªO: plan
¼Ð  ÃD: Re: [°ÝÃD]¥\¯à-¤å³¹½s¿è®ÉµLªk¥[¤À
µo«H¯¸: °Ê¤O®Ö¤ß (2007/04/05 Thu 23:18:34)                Updated: 2007/04/06

  post_edit() ¸Ìªº vedit() «e/«á¡A¥[¤W/²¾°£ POST_EDITING ºX¼Ð
  post_score() ¦bµû¤À«e¡A­Yµo²{¦³ POST_EDITING ºX¼Ð¡A«h¸T¤îµû¤À

  µ{¦¡·|¦Û°Ê­×´_·í§@ªÌ½s¿è¤£¥¿±`Â_½u®É´Ý¯dªº POST_EDITING
  ¦ý¬O­Y§@ªÌ¤£¥¿±`Â_½u¤S°¨¤W³s½u¡A¦ý¤£¦A¥h½s¿è¸Ó¤å³¹®É¡A´Ý¯dªº POST_EDITING
  µ{¦¡¤]¤£·|­×´_·í¯¸ªø¤£¥¿±`Â_½u®É´Ý¯dªº POST_EDITING_AD
  ¦¹®É¡A¥u­n§@ªÌ©Î¯¸ªø¦A¥h Edit ¤@¦¸¡A¥¿±`Â÷¶}½s¿è§Y¥i (¤£ºÞ¦³µLÀx¦s³£¥i¥H)

  ¦pªG§@ªÌ¶}¤G­Óµøµ¡¦P®É Edit ¦P¤@½g¤å³¹
  ¨º»ò¨ä¤¤¤@­Óµøµ¡Â÷¶} Edit «á¡A´N¥i¥H¶}©lµû¤À¤F
  ¤Ï¥¿¥Ø«e¤]¨SºÞ¡u§@ªÌ¶}¤G­Óµøµ¡¦P®É Edit ¦P¤@½g¤å³¹®É¡A±ßÀx¦s·|ÂÐ»\¥ýÀx¦s¡v
  ©Ò¥H¤]¤£¥´ºâ¼g¦¹±¡ªp¤Uªº¸T¤îµû¤ÀÀË¬d

: hdr.h

- #define POST_3          0x00000004
+ #define POST_EDITING    0x00000004   /* editing by author */

- #define POST_4          0x00000008
+ #define POST_EDITING_AD 0x00000008   /* editing by admin */

: post.c:post_edit()

  if (HAS_PERM(PERM_ALLBOARD))                  /* ¯¸ªø­×§ï */
  {
    ...
    ...
+   do_editing(xo, 1);
    vedit(fpath, 0);
+   do_editing(xo, -1);
  }
  else if (cuser.userlevel && !strcmp(hdr->owner, cuser.userid))
  {
+   do_editing(xo, 2);
    if (!vedit(fpath, 0))
    {
      ...
      ...
    }
+   do_editing(xo, -2);
  }

: post.c:do_editing() ·s¼W¦¹¨ç¦¡¦b post_edit() «e­±

static void
do_editing(xo, flag)
  XO *xo;
  int flag;
{
  HDR *hdr;
  int pos, xmode;

  pos = xo->pos;
  hdr = (HDR *) xo_pool + (pos - xo->top);
  xmode = hdr->xmode;

  if (flag == 1)
    hdr->xmode = xmode | POST_EDITING_AD;
  else if (flag == -1)
    hdr->xmode = xmode & ~POST_EDITING_AD;
  else if (flag == 2)
    hdr->xmode = xmode | POST_EDITING;
  else if (flag == -2)
    hdr->xmode = xmode & ~POST_EDITING;

  currchrono = hdr->chrono;
  rec_put(xo->dir, hdr, sizeof(HDR), xo->key == XZ_XPOST ?
    hdr->xid : pos, cmpchrono);
}

: post.c:post_score()

  pos = xo->pos;
  cur = pos - xo->top;
  hdr = (HDR *) xo_pool + cur;

+ if (is_editing(xo, hdr))
+ {
+    vmsg("¥Ø«e§@ªÌ©Î¯¸ªø¥¿½s¿è¦¹¤å³¹¤¤¡A¼È®É¸T¤îµû¤À");
+    return XO_FOOT;
+ }

: post.c:is_editing() ·s¼W¦¹¨ç¦¡¦b post_score() «e­±

static int
is_editing(xo, hdr)
  XO *xo;
  HDR *hdr;
{
  HDR hdd;
  int fd;
  int rc = 0;
  time_t chrono;

  /* ¥Ñ©ó¨Ï¥ÎªÌ¤â¤Wªº xo_pool[] ¥i¯à¬OÂÂªº (§Y¨Ï¥ÎªÌ¤w¸g¦bªO¤º¡A
     ³o®É§@ªÌ¤~½s¿è¸Ó¤å³¹)¡A©Ò¥Hª½±µ¥h§äµwºÐ³Ì¥¿½Tªº */

  chrono = hdr->chrono;

  if ((fd = open(xo->dir, O_RDONLY)) >= 0)
  {
    while (read(fd, &hdd, sizeof(HDR)) == sizeof(hdd))
    {
      if (chrono == hdd.chrono)
      {
        rc = (hdd.xmode & (POST_EDITING | POST_EDITING_AD));
        break;
      }
    }
    close(fd);
  }

  if (rc & POST_EDITING_AD)       /* ¦³¯¸ªø¥¿¦b½s¿è */
    return 1;

  /* ­Y¥»¤å³¹¥u¦³ POST_EDITING¡A¦AÀË¬d§@ªÌ¬O§_¦b¯¸¤W */

  if (rc)
  {
    extern UCACHE *ushm;
    UTMP *uentp, *uceil;

    uentp = ushm->uslot;
    uceil = (void *) uentp + ushm->offset;
    do
    {
      if (!strcmp(uentp->userid, hdd.owner))
        return 1;
    } while (++uentp <= uceil);
  }

  /* ­Y¥u¦³ POST_EDITING¡A¦ý§@ªÌ¤£¦b¯¸¤W¡A
     ªí¥Ü§@ªÌ¤£¥¿±`Â_½u¡A²¾°£ POST_EDITING */
  do_editing(xo, -2);

  return 0;
}

--
[1;36m=[37m[[36m¡É[37m:[33m¡[37mÝ¢¨[m¢©¡[1;33mÝ[37m:[36m¡É [31mOrigin[37m ]|[[m  [0;31m°[1mÊ[1m¤[0;31mO[0;31m®[1mÖ[1m¤[0;31mß [1mcpu.tfcis.org  [37m]|[¡[33mÝ£»¡[mÝ[1;36m¡É[37m:][36m=[m
[1;36m=[0m[[1;36m¡Ç[37m:[33m¡[30mÝ¢ª[m¢¬¡[1;33mÝ[37m:[36m¡Ç [31mAuthor[m ]|[[1m218-168-186-195.dynamic.hi[m]|[¡[1;33mÝ[30m¡[37m´¡[30mÝ[36m¡Ç[37m:[m][1;36m=[m
